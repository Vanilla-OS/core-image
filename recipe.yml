base: ghcr.io/vanilla-os/pico:main
name: Vanilla Core
singlelayer: false
labels:
  maintainer: Vanilla OS Contributors
args:
  DEBIAN_FRONTEND: noninteractive
runs:
- echo 'APT::Install-Recommends "0";' > /etc/apt/apt.conf.d/01norecommends

modules:
- name: mandb
  type: shell
  commands:
  - apt update
  - apt install -y man-db
  - mandb -c

- name: abroot
  type: shell
  source:
    type: tar
    # switch to production build once in production
    url: https://github.com/Vanilla-OS/ABRoot/releases/download/continuous/abrootv2.tar.gz
  commands:
  - apt install -y podman golang-github-containers-common
  - mkdir -p /usr/bin
  - cp /sources/abrootv2 /usr/bin/abroot
  - chmod +x /usr/bin/abroot

  # Dependency of Apx, do not remove
- name: distrobox
  type: shell
  source:
    type: tar
    url: https://github.com/89luca89/distrobox/archive/refs/tags/1.5.0.2.tar.gz
  commands:
  - mkdir -p /usr/share/apx
  - cp -r /sources/distrobox-1.5.0.2 /usr/share/apx/distrobox
  - chmod +x /usr/share/apx/distrobox/distrobox*

- name: apx
  type: shell
  source:
    type: tar
    # switch to production build once in production
    url: https://github.com/Vanilla-OS/apx/releases/download/continuous/apx.tar.gz
  commands:
  - mkdir -p /usr/bin
  - cp /sources/apx /usr/bin/apx
  - chmod +x /usr/bin/apx
  - |
    echo '{\n\
      "apxPath": "/usr/share/apx",\n\
      "distroboxpath": "/usr/share/apx/distrobox/distrobox",\n\
      "storageDriver": "btrfs"\n\
    }' > /usr/share/apx/apx.json

- name: apx-stacks
  type: shell
  source:
    type: git
    url: https://github.com/Vanilla-OS/vanilla-apx-configs.git
    branch: main
    commit: 559ed2ca42d4accbe443bf94da40cb8a31e6181d
  commands:
  - mv /sources/apx-stacks/stacks /usr/share/apx/
  - mv /sources/apx-stacks/package-managers /usr/share/apx/

- name: ikaros
  type: shell
  source:
    type: tar
    # switch to production build once in production
    url: https://github.com/Vanilla-OS/Ikaros/releases/download/continuous/ikaros.tar.gz
  commands:
  - mkdir -p /usr/bin
  - cp /sources/ikaros /usr/bin/ikaros
  - chmod +x /usr/bin/ikaros

- name: fsguard
  type: shell
  source:
    type: tar
    url: https://github.com/linux-immutability-tools/FsGuard/releases/download/v0.1.1/FsGuard_0.1.1_linux_amd64.tar.gz
  commands:
  - apt install -y minisign
  - mv /sources/FsGuard /usr/bin
  - /usr/bin/gen_fsguard_filelist /usr/bin
  - sed -i '\/usr\/bin\/gen_fsguard_filelist.*/d' /FsGuard/filelist
  - sed -i '\/usr\/bin\/sign_filelist.*/d' /FsGuard/filelist
  - /usr/bin/sign_filelist

- name: packages-modules
  type: gen-modules
  path: modules

- name: cleanup
  type: shell
  commands:
  - apt remove -y dpkg-dev
  - apt autoremove -y
  - apt clean
  - rm -rf /var/cache/*
  - rm -rf /tmp/*
  - rm -rf /var/tmp/*
  - rm -rf /sources
  - rm /usr/bin/gen_fsguard_filelist
  - rm /usr/bin/sign_filelist
  - mkdir -p /var/cache/apt/archives/partial
